#!/usr/bin/env bash
set -eo pipefail; [[ $DOKKU_TRACE ]] && set -x

APP="$1"
IMAGE="$2"
HOSTNAME=$(hostname -f)

if [[ -f "$DOKKU_ROOT/$APP/SLACK_URL" || -f "$DOKKU_ROOT/SLACK_URL" ]]; then
  URL=$(dokku url $APP)
  SLACK_URL=$(cat "$DOKKU_ROOT/$APP/SLACK_URL" 2> /dev/null || cat "$DOKKU_ROOT/SLACK_URL" 2> /dev/null)
  SLACK_CHANNEL=$(cat "$DOKKU_ROOT/$APP/SLACK_CHANNEL" 2> /dev/null || cat "$DOKKU_ROOT/SLACK_CHANNEL" 2> /dev/null || echo "#engineering")
  echo "-----> Notifying Slack ${SLACK_CHANNEL}..."
  GIT_COMMIT_HASH=$(cd "$DOKKU_ROOT/$APP"; git rev-parse --short HEAD 2> /dev/null || echo "init dokku setup")
  GIT_MESSAGE=$(cd "$DOKKU_ROOT/$APP"; git log -1 --pretty="%B" 2> /dev/null || echo " ")
  SLACK_JSON="{ \
    \"channel\": \"$SLACK_CHANNEL\", \
    \"attachments\": [{ \
      \"text\": \"Deployed *$APP* \`$GIT_COMMIT_HASH\` to *$HOSTNAME* via $URL\n$GIT_MESSAGE\", \
      \"fallback\": \"Deployed $APP to $HOSTNAME via $URL\", \
      \"color\": \"good\", \
      \"mrkdwn_in\": [\"text\"] \
    }] \
  }"
  SLACK_RESULT=$(curl -s -d "payload=$SLACK_JSON" "${SLACK_URL}" -w "%{http_code}")
  echo "       ${SLACK_RESULT}"
fi
